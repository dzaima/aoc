#!/usr/bin/env bqn
âŸ¨InputâŸ© â† â€¢Import "../../utils/utils.bqn"
l â† â€¢FChars 2015â€¿4 Input â€¢args

Sq â† â€¢internal.Squeeze
cÂ¯32 â† 2â‹†32
U32 â† Sq -âŸœ(cÂ¯32Ã—â‰¥âŸœ(cÂ¯32Ã·2))
Bits32 â† 32â€¿1â€¢bit._cast
Add32 â† 32â€¿1â€¢bit._add

# constants
cÂ¯k â† U32 âŒŠcÂ¯32Ã—|â€¢math.Sin 1+â†•64
cÂ¯s â† âˆ¾16âŠ¸â¥ŠÂ¨ âŸ¨7â€¿12â€¿17â€¿22, 5â€¿ 9â€¿14â€¿20, 4â€¿11â€¿16â€¿23, 6â€¿10â€¿15â€¿21âŸ©

cÂ¯abcd â† U32 1732584193â€¿4023233417â€¿2562383102â€¿271733878
cÂ¯rounds â† {
  fsâ€¿gs â† <Ë˜â‰>âŸ¨
    {ğ•Šaâ€¿bâ€¿câ€¿d: d â‰  b âˆ§ câ‰ d}â€¿{ğ•Ši: i}
    {ğ•Šaâ€¿bâ€¿câ€¿d: c â‰  d âˆ§ bâ‰ c}â€¿{ğ•Ši: 16|1+5Ã—i}
    {ğ•Šaâ€¿bâ€¿câ€¿d:   b â‰  c â‰  d}â€¿{ğ•Ši: 16|5+3Ã—i}
    {ğ•Šaâ€¿bâ€¿câ€¿d:  c â‰  b âˆ¨ Â¬d}â€¿{ğ•Ši: 16|  7Ã—i}
  âŸ©
  { ğ•Š i:
    r â† âŒŠğ•©Ã·16
    g â† {ğ• i} râŠ‘gs
    âŸ¨râŠ‘fs, g, Bits32â‹ˆ iâŠ‘cÂ¯k, -iâŠ‘cÂ¯sâŸ©
  }Â¨ â†•64
}

# takes a mask of which bits to check being 0 in the first 32 bits (in a weird order)
MD5P â† {
  n â† â‰ ğ•©
  lenBits â† 8Ã—â‰ âŠ‘ğ•©
  padLen â† 8+ 32|-8+lenBits
  heads â† 1â‰ nâ€¿âˆ˜â€¿32 â¥Š âˆ¾âŸœ(padLenâ†‘Â¯8â†‘1)Ë˜ 8â€¿1â€¢bit._cast >ğ•©
  headWords â† 32Ã·Ëœ lenBits+padLen
  const â† âˆ˜â€¿32â¥Š Â¯512 â†‘ 64â†‘ Bits32 â‹ˆlenBits
  
  aâ€¿bâ€¿câ€¿d â† (Bits32 nâ€¿1âŠ¸â¥Š)Â¨ cÂ¯abcd
  a0 â† a
  
  { Fâ€¿gâ€¿kâ€¿ns:
    f â†© F aâ€¿bâ€¿câ€¿d
    f â†© f Add32 a Add32 k Add32 {g<headWords? gâŠheads; gâŠconst}
    a â†© d
    d â†© c
    c â†© b
    # rot â† ns âŒ½Ë˜ f
    rot â† (nsâŒ½â†•32)âŠ¸âŠË˜ "Ai8"â€¢internal.Variation f # hack for the above being even slower in CBQN; TODO don't
    b â†© b Add32 rot
    @
  }Â¨ cÂ¯rounds
  r â† a0 Add32 a
  âˆ¨ËË˜ ğ•¨ âˆ§â‰1 r
} {1=â‰ â·â‰ Â¨ğ•©? ğ•¨ğ”½ğ•©; ğ•¨âŠ¸ğ”½Â¨âŒ¾((âŠâ‰ Â¨ğ•©)âŠ¸âŠ”) ğ•©}



chunk â† 3000
Min â† { tgt ğ•Š start:
  tgt â†© 4/tgt-'0'
  found â† @
  {
    m â† tgt MD5P (lâˆ¾â€¢Repr)Â¨ ğ•©
    ğ•©{ğ•¤â‹„ found â†© âŠ‘mÂ¬âŠ¸/ğ•—}âŸÂ¬ âˆ§Â´m
    ğ•©+chunk
  } â€¢_while_{ğ•Š: @â‰¡found} start+â†•chunk
  found
}

â€¢Show p1 â† "11110100" Min 1
â€¢Show p2 â† "11111100" Min p1

# â€¢Show 1e9Ã— 3000Ã·Ëœ 1e3 (4/"11111100"-'0')âŠ¸MD5Pâ€¢_timed (lâˆ¾â€¢Repr)Â¨ 1e5+â†•3000 # nanoseconds per hash bench


# test code for comparing that results are equal for the basic version
# MD5 â† {
#   m â† 8â€¿1â€¢bit._cast ğ•©
#   mâˆ¾â†© âŒ½8â†‘1
#   mâˆ¾â†© 0â¥ŠËœ512|448-â‰ m
#   ! (â‰ ğ•©)<2â‹†28 # lazy length computation
#   mâˆ¾â†© 64â†‘ Bits32 â‹ˆ8Ã—â‰ ğ•©
#   abcd0 â† Bits32âˆ˜â‹ˆÂ¨ cÂ¯abcd
#   {
#     m â† ğ•©
#     aâ€¿bâ€¿câ€¿d â† abcd0
#     { Fâ€¿gâ€¿kâ€¿ns:
#       # â€¢Show '0'+ >aâ€¿bâ€¿câ€¿d
#       f â†© F aâ€¿bâ€¿câ€¿d
#       f â†© f Add32 a Add32 k Add32 gâŠm
#       a â†© d
#       d â†© c
#       c â†© b
#       b â†© b Add32 ns âŒ½ f
#     }Â¨ cÂ¯rounds
#     abcd0 Add32Â¨â†© aâ€¿bâ€¿câ€¿d
#     @
#   }Ë˜ âˆ˜â€¿16â€¿32â¥Š m
#   â¥ŠâŒ½Ë˜âˆ˜â€¿2â¥Š +ËË˜(2â‹†â†•4) Ã—â‰1 âˆ˜â€¿4â¥Šâˆ¾abcd0
# }

# { ğ•Š:
#   gr â† (lâˆ¾â€¢Repr)Â¨ 10 â€¢rand.Range 100000
#   exp â† (0â‰ âŠ‘âˆ˜MD5)Â¨ gr
#   got â† (4/"01000000"-'0') MD5P gr
#   gr ! exp â‰¡ got
# }Â¨ â†•10000
