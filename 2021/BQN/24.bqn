#!/usr/bin/env cbqn
âŸ¨SIntâŸ© â† â€¢Import "utils.bqn"
l â† â€¢FLines â‰ â—¶"24.in"â€¿âŠ‘ â€¢args

# guesses a digit at a time, by trying 100â€¦1000 (depending on position) random inputs (with some mutation)

Train â† {
  inpCtr â† 0
  Res â† âŠ¢
  
  _set â† {ğ•¨âŒ¾(ğ•—âŠ¸âŠ‘)ğ•©}
  { ğ•Šins:
    ty â† 3â†‘ins
    v1 â† (4âŠ‘ins)-'w'
    {
      tyâ‰¡"inp"?
        Res â†© (inpCtrâŠ‘âŠ£) v1 _set Res
        inpCtr+â†©1;
      # else
        Div â† (Ã—Ã—âŒŠâˆ˜|)Ã· # alternative funky dzaima/BQN: âŒŠâŒ¾|Ã·
        Mod â† |Ëœ
        op â† (âŠ‘"duioq"âŠ1âŠ‘ty) âŠ‘ +â€¿Ã—â€¿Divâ€¿Modâ€¿=
        {
          (â‰¥âŸœ'w'âˆ§â‰¤âŸœ'z')6âŠ‘ins?
            v2 â† (6âŠ‘ins)-'w'
            Res â†© (((v1âŠ‘âŠ¢) Op v2âŠ‘âŠ¢) v1 _set âŠ¢) Res;
          # else
            n â† SInt 6â†“ins
            Res â†© (((v1âŠ‘âŠ¢) Op N) v1 _set âŠ¢) Res
        }
    }
  }Â¨ğ•©
  3âŠ‘âŠ¢ Res 0â€¿0â€¿0â€¿0Ë™
}

Comp â† {
  inpCtr â† 0
  nlâ†âŸ¨@+10âŸ©
  res â† "{wâ†0â‹„xâ†0â‹„yâ†0â‹„zâ†0"âˆ¾nl
  { ğ•Šins:
    ty â† 3â†‘ins
    v1 â† 4âŠ‘ins
    {
      tyâ‰¡"inp"?
        resâˆ¾â†© âˆ¾âŸ¨v1,"â†©",â€¢Repr inpCtr,"âŠ‘ğ•©",nlâŸ©
        inpCtr+â†©1;
      # else
        op â† (âŠ‘"duioq"âŠ1âŠ‘ty) âŠ‘ "+"â€¿"Ã—"â€¿"((Ã—Ã—âŒŠâˆ˜|)Ã·)"â€¿"|Ëœ"â€¿"="
        {
          (â‰¥âŸœ'w'âˆ§â‰¤âŸœ'z')6âŠ‘ins?
            v2 â† 6âŠ‘ins
            resâˆ¾â†© âˆ¾âŸ¨v1,"â†©",v1,op,v2,nlâŸ©;
          # else
            n â† SInt 6â†“ins
            #Res â†© (((v1âŠ‘âŠ¢) Op N) v1 _set âŠ¢) Res
            resâˆ¾â†© âˆ¾âŸ¨v1,"â†©",v1,op,â€¢Repr n,nlâŸ©
        }
    }
  }Â¨ğ•©
  â€¢BQN âˆ¾âŸ¨res,nl,"z}"âŸ©
}

OptComp â† { ğ•Š:
  inpCtr â† 0
  nlâ†âŸ¨@+10âŸ©
  val0 â† âŸ¨'c',0âŸ©
  vars â† 4â¥Š<val0
  SetVar â† {varsğ•©âŒ¾(ğ•¨âŠ¸âŠ‘)â†©}
  instrs â† âŸ¨âŸ©
  instrUsage â† â†•0
  IncUsage â† {instrUsage+âŸœ1âŒ¾((1âŠ‘ğ•©)âŠ¸âŠ‘)â†©}âŸ('r'â‰¡âŠ‘)
  AddInstr â† { opidâ€¿râ€¿laâ€¿ra:
    IncUsageÂ¨ laâ€¿ra
    instrsâˆ¾â†© <âŸ¨opid, la, raâŸ©
    instrUsageâˆ¾â†© 0
    r SetVarâŸ(râ‰¢@) âŸ¨'r'â‹„Â¯1+â‰ instrsâŸ©
  }
  
  { ğ•Šins:
    ty â† 3â†‘ins
    v1 â† 'w'-Ëœ4âŠ‘ins
    #        012345
    #        i+Ã—Ã·|=
    opid â† âŠ‘"nduioq"âŠ1âŠ‘ty
    {
      opidâ‰¡0? v1 SetVar âŸ¨'i'â‹„inpCtrâŸ© â‹„ inpCtr+â†©1;
      v1v â† v1âŠ‘vars
      v2v â† {(â‰¥âŸœ'w'âˆ§â‰¤âŸœ'z')6âŠ‘ins? varsâŠ‘Ëœ'w'-Ëœ6âŠ‘ins; âŸ¨'c'â‹„SInt 6â†“insâŸ©}
      {
        "cc"â‰¡âŠ‘Â¨v1vâ€¿v2v?
          v1 SetVar âŸ¨'c',v1v opidâ—¶âŸ¨@,+,Ã—,(Ã—Ã—âŒŠâˆ˜|)Ã·,|Ëœ,=âŸ©â—‹(1âŠ¸âŠ‘) v2vâŸ©;
        (âŠ‘(<val0)âˆŠv1vâ€¿v2v) âˆ§ opidâ‰¡1? # 0+x, x+0
          v1 SetVar (val0â‰¡v1v)âŠ‘v1vâ€¿v2v;
        (âŠ‘(<val0)âˆŠv1vâ€¿v2v) âˆ§ opidâ‰¡2? # 0Ã—x, xÃ—0
          v1 SetVar val0;
        (v2vâ‰¡âŸ¨'c'â‹„1âŸ©) âˆ§ opidâ‰¡3? # xÃ·1
          @;
        # default:
          AddInstr opidâ€¿v1â€¿v1vâ€¿v2v
      }
    }
  }Â¨ ğ•©
  IncUsage 3âŠ‘vars
  
  res â† âˆ¾âŸ¨"{",1â†“âˆ¾"â€¿i"âŠ¸âˆ¾Â¨â€¢ReprÂ¨â†•14,"â†ğ•©â‹„RTZâ†Ã—Ã—âŒŠâˆ˜|",nlâŸ©
  GenOp â† {
    ğ•¨ğ•Š'c'â€¿n: â€¢Repr n;
    ğ•¨ğ•Š'r'â€¿n: ğ•¨{1<nâŠ‘instrUsage? "t"âˆ¾â€¢Repr n; {"("âˆ¾ğ•©âˆ¾")"}âŸğ•¨ GenInstr nâŠ‘instrs}ğ•©;
    ğ•¨ğ•Š'i'â€¿n: "i"âˆ¾â€¢Repr n;
    "idk"
  }
  GenInstr â† { opidâ€¿lâ€¿r:
    {
      opidâ‰¡4? âˆ¾âŸ¨         1 GenOp r â‹„ "|" â‹„ 0 GenOp lâŸ©;
      opidâ‰¡3? âˆ¾âŸ¨"RTZ " â‹„ 1 GenOp l â‹„ "Ã·" â‹„ 0 GenOp râŸ©;
      âˆ¾âŸ¨1 GenOp l â‹„ opid âŠ‘ ""â€¿"+"â€¿"Ã—"â€¿"((Ã—Ã—âŒŠâˆ˜|)Ã·)"â€¿"|Ëœ"â€¿"=" â‹„ 0 GenOp râŸ©
    }
  }
  (â†•â‰ instrs) {resâˆ¾â†© âˆ¾âŸ¨"t",â€¢Reprğ•¨,"â†",GenInstr ğ•©,nlâŸ©}Â¨â—‹((instrUsage>1)âŠ¸/) instrs
  â€¢BQN res âˆ¾ âˆ¾âŸ¨0 GenOp 3âŠ‘vars â‹„ nl,"}"âŸ©
}

# f â† Train l # compile to trains
# f â† Comp l # simple transpilation to BQN
f â† OptComp l # SSAified transpilation to BQN with constant folding

# â€¢Show 2e5 Fâ€¢_timed 14â¥Š5
# ! 4154727576 â‰¡ F 10|â†•14


Any â† { # guesses if the prefix ğ•© gives any valid model numbers
  # â€¢Show ğ•© # uncomment for progress display
  initV â† ğ•©
  initL â† â‰ ğ•©
  
  Mut â† {ğ•Ši:
    opt â† â¥Š(1+â†•9) {ğ•¨âŒ¾(ğ•©âŠ¸âŠ‘)i}âŒœ initL+â†•14-initL
    optâŠ‘Ëœ(âŠ‘âŠ¢âŠâŒŠÂ´)FÂ¨ opt
  }
  0 { ğ•¨ğ•Š1:1;ğ•¨ğ•Š0:
    i0 â† initVâˆ¾1+(14-initL)â€¢rand.Range 9
    0â‰¡F 2âŠ‘{sâ€¿Â·â€¿p: âŸ¨s+1â‹„pâ‹„Mut pâŸ©}â€¢_while_{sâ€¿pâ€¿n: (s<20)âˆ§pâ‰¢n} âŸ¨0 â‹„ i0 â‹„ Mut i0âŸ©
  }Â´ â†•initLâŠ‘1000â€¿1000â€¿500â€¿500â€¿500â€¿100â€¿100â€¿100â€¿100â€¿100â€¿100â€¿100â€¿100â€¿100
}

Find â† { ğ•Šorder:
  c â† âŸ¨âŸ©
  {ğ•Š:
    câˆ¾â†© @ {ğ•¨ğ•Š@:Any câˆ¾ğ•¨?ğ•¨;@}âŸ(@â‰¡âŠ¢)Â´ âŒ½order
  }Â¨â†•10
  c âˆ¾ âŠ‘(0=(F câˆ¾âŠ¢)Â¨)âŠ¸/ â¥Šâˆ¾âŒœÂ´4â¥Š<âŒ½order
}

â€¢Out '0'+Find âŒ½1+â†•9
â€¢Out '0'+Find  1+â†•9
