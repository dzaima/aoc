#!/usr/bin/env cbqn
âŸ¨RB, B10, Num, Ints, SInts, SplitâŸ© â† â€¢Import "utils.bqn"
l â† {âŸ¨'n'=1âŠ‘ğ•© â‹„ 0â€¿1+<Ë˜â‰3â€¿2â¥ŠSIntsğ•©âŸ©}Â¨ â€¢FLines â‰ â—¶"22.in"â€¿âŠ‘ â€¢args

# remove ğ•© from the cube ğ•¨; assumes there actually is an intersection
Diff â† {ğ•Šsâ€¿e: âˆ§Â´s<e}Â¨âŠ¸/ { âŸ¨sKxâ€¿sKyâ€¿sKzâ‹„eKxâ€¿eKyâ€¿eKzâŸ© ğ•Š âŸ¨sRxâ€¿sRyâ€¿sRzâ‹„eRxâ€¿eRyâ€¿eRzâŸ©:
  sz â† (sKzâŒˆsRz) â‹„ ez â† (eKzâŒŠeRz)
  sy â† (sKyâŒˆsRy) â‹„ ey â† (eKyâŒŠeRy)
  âŸ¨
    âŸ¨sKxâ€¿sKyâ€¿eRz â‹„ 1âŠ‘ğ•¨âŸ©
    âŸ¨âŠ‘ğ•¨ â‹„ eKxâ€¿eKyâ€¿sRzâŸ©
    âŸ¨sKxâ€¿eRyâ€¿sz â‹„ eKxâ€¿eKyâ€¿ezâŸ©
    âŸ¨sKxâ€¿sKyâ€¿sz â‹„ eKxâ€¿sRyâ€¿ezâŸ©
    âŸ¨eRxâ€¿syâ€¿sz â‹„ eKxâ€¿eyâ€¿ezâŸ©
    âŸ¨sKxâ€¿syâ€¿sz â‹„ sRxâ€¿eyâ€¿ezâŸ©
  âŸ©
}

Do â† {
  rsâ€¿re â† â‹ˆËœ 3â¥Š<â†•0
  
  Add â† {
    ğ•Šğ•©: 0ğ•Šğ•©;
    siğ•Šasâ€¿ae:
      i â† âˆ§Â´(as<siâ†“Â¨re)âˆ§ae>siâ†“Â¨rs
      âˆ¨Â´i?
        pos â† si+âŠ‘/i
        iv â† posâŠ‘Â¨Â¨rsâ€¿re
        pos AddÂ¨ asâ€¿ae Diff iv;
    Â·ğ•ŠÂ·:
    # long version of `rsâ€¿reâˆ¾Â¨Â¨â†© ğ•©` as Â¨ keeps references unnecessarily; 50% boost; TODO don't
      rs{xâ€¿yâ€¿zâ†ğ•¨ â‹„ axâ€¿ayâ€¿azâ†ğ•© â‹„ âŸ¨xâˆ¾ax,yâˆ¾ay,zâˆ¾azâŸ©}â†©0âŠ‘ğ•©
      re{xâ€¿yâ€¿zâ†ğ•¨ â‹„ axâ€¿ayâ€¿azâ†ğ•© â‹„ âŸ¨xâˆ¾ax,yâˆ¾ay,zâˆ¾azâŸ©}â†©1âŠ‘ğ•©
  }
  Sub â† {ğ•Šasâ€¿ae:
    i â† âˆ§Â´(as<re)âˆ§ae>rs
    iv â† iâŠ¸/Â¨Â¨ rsâ€¿re
    rsâ€¿re (Â¬i)âŠ¸/Â¨Â¨â†©
    (/i) {ğ•¨ AddÂ¨ ğ•© Diff asâ€¿ae}Â¨ <Ë˜â‰>{<Ë˜â‰>ğ•©}Â¨ iv
  }
  
  {ğ•Š âŸ¨onâ‹„câŸ©: onâ—¶Subâ€¿Add c}Â¨ ğ•©
  +Â´{Ã—Â´-ËœÂ´ğ•©} rsâ€¿re
}

â€¢Show Do {âŸ¨vâ‹„sâ€¿eâŸ©: âˆ§Â´ (sâ‰¥Â¯50)âˆ§eâ‰¤50}Â¨âŠ¸/ l
â€¢Show Do l