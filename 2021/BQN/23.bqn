#!/usr/bin/env -S cbqn -M 2000
âŸ¨RB, B10, Num, Ints, SInts, SplitâŸ© â† â€¢Import "utils.bqn"
l â† <Ë˜â‰>'A'-Ëœ2â€¿3âŠ'A'âŠ¸â‰¤âŠ¸/Â¨â€¢FLines â‰ â—¶"23.in"â€¿âŠ‘ â€¢args

scores â† 1â€¿10â€¿100â€¿1000
exits â† 2â€¿4â€¿6â€¿8

Fmt â† {sâ€¿fâ€¿r:
  â€¢Out "â•"âˆ¾(fâŠ"ABCD.")âˆ¾"â•  "âˆ¾â€¢Repr s
  lns â† <Ë˜â‰>âˆ¾((â‰ âŠ‘r)â¥Š'â•')âŠ¸â‹ˆÂ¨râŠÂ¨<"ABCD."
  (â†•â‰ lns) {
  Ã—ğ•¨? â€¢Out "  "âˆ¾ğ•©âˆ¾"â•";
      â€¢Out "â•â•"âˆ¾ğ•©âˆ¾"â•â•â•"
  }Â¨ lns
}

Do â† {
  minScâ†âˆ
  nextKs â† â†•0
  nextVs â† âŸ¨âŸ©
  # Next â† {Get ğ•©} # in case of a need for some filtering
  Next â† {nextKsâˆ¾â†© âŠ‘ğ•© â‹„ nextVsâˆ¾â†© <1â†“ğ•© â‹„ 1}
  Get â† { sâ€¿fâ€¿r:
    ft â† 4â‰ f # which spaces outside are free
    {
      sorted â† âˆ§Â´Â¨ (r=4) âˆ¨ r=â†•4
      {âˆ§Â´sorted? âˆ§Â´f=4? minScâŒŠâ†©s;0}
      ee â† (4=âŠ‘Â¨r) âˆ§ sorted # whether the room is currently enterable
      âˆ¨Â´ee? {
        0 { # try to move ones on the hallway to their homes
          v â† ğ•©âŠ‘f
          vâ‰ 4?
          vâŠ‘ee?
          end â† vâŠ‘exits
          âˆ§Â´4=(end {sğ•Še: s+-âŸ(e<s)â†•|e-s} ğ•©)âŠf?
          pos â† Â¯1+Â´âˆ§`4=vâŠ‘r
          nf â† 4âŒ¾(ğ•©âŠ¸âŠ‘)f
          nr â† vâŒ¾(posâŠ‘vâŠ¸âŠ‘) r
          Next âŸ¨s+(vâŠ‘scores)Ã—pos+1+|end-ğ•© â‹„ nf â‹„ nrâŸ©
          1
          ;0
        }âˆ˜âŠ£âŸ(Â¬âŠ¢)Â´ â†•â‰ f? 1;
        0 { # try to move from home to home
          cr â† ğ•©âŠ‘r
          nz â† 4â‰ cr
          âˆ¨Â´nz?
          xpos â† âŠ‘/nz # exit pos
          v â† xposâŠ‘cr
          vâŠ‘ee? # move only if actually possible
          vâ‰ ğ•©? # don't move from own home
          xx â† ğ•©âŠ‘exits # exiting exit
          ex â† vâŠ‘exits # entering exit
          âˆ§Â´4=(xx {sğ•Še: s+-âŸ(e<s)â†•1+|e-s} ex)âŠf? # whether the hallway is free for the move
          epos â† Â¯1+Â´âˆ§`4=vâŠ‘r # enter pos
          Next âŸ¨s+(vâŠ‘scores)Ã—xpos+epos+2+|ex-xx â‹„ f â‹„ 4âŒ¾(xposâŠ‘ğ•©âŠ¸âŠ‘) vâŒ¾(eposâŠ‘vâŠ¸âŠ‘) râŸ©
          1
          ;0
        }âˆ˜âŠ£âŸ(Â¬âŠ¢)Â´ â†•4? 1;
        0
      }? 1;
      
      # else, noone can yet move into their rooms; move out
      {
        nz â† 4â‰ ğ•©âŠ‘r
        âˆ¨Â´nz? # does the current room even have anything
        ex â† ğ•©âŠ‘exits
        4=exâŠ‘f? # is the space immediately outside free?
        d â† âŸ¨(âŒ½exâ†‘ft)âŠ‘âˆ˜âŠ1 â‹„ ((ex+1)â†“ft)âŠ‘âˆ˜âŠ1âŸ©
        âˆ¨Â´4â‰ d?
        pos â† âŠ‘/nz
        v â† posâŠ‘ğ•©âŠ‘r
        âˆ¨Â´(4â‰ ğ•©âŠ‘r)âˆ§ğ•©â‰ ğ•©âŠ‘r? # am I not already in the correct room
        nr â† 4âŒ¾(posâŠ‘ğ•©âŠ¸âŠ‘) r
        sc â† vâŠ‘scores
        Â¯1â€¿1 {dirğ•Šğ•©:
          {npâ†ex+dirÃ—ğ•© â‹„ âˆ§Â´npâ‰ exits? Next âŸ¨s+scÃ—pos+1+ğ•© â‹„ vâŒ¾(npâŠ¸âŠ‘)f â‹„ nrâŸ©;0}Â¨ 1+â†•ğ•©
        }Â¨ d
        ğ•©
      ;0}Â¨ â†•4
    }
  }
  Get âŸ¨0 â‹„ 11â¥Š4 â‹„ ğ•©âŸ©
  {ğ•Š:
    bestIs â† {ğ•©âŠ‘ËœâŠ‘(âŠ¢âŠâŒŠÂ´)ğ•©âŠnextKs}Â¨ âŠ”âŠ nextVs
    vsâ†(bestIsâŠnextKs)âˆ¾Â¨bestIsâŠnextVs
    nextVs â†© âŸ¨âŸ©
    nextKs â†© â†•0
    GetÂ¨ vs
  } â€¢_while_{ğ•Š: Ã—â‰ nextKs} @
  minSc
}
â€¢Show Do l
â€¢Show Do "DD"â€¿"CB"â€¿"BA"â€¿"AC" {ğ•¨ğ•Šr0â€¿r3: r0âˆ¾(ğ•¨-'A')âˆ¾r3}Â¨ l