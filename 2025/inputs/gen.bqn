#!/usr/bin/env bqn
# Usage: ./gen.bqn outputFilename [seed (u for random, 1 for default)] [...day-specific args]
# Day number is inferred as the numeric prefix of the filename
MakeRand â† â€¢MakeRand
âŸ¨MDSlashâŸ© â† â€¢Import "../../utils/utils.bqn"

Join â† {(â‰ ğ•¨)â†“ âˆ¾ ğ•¨âŠ¸âˆ¾Â¨ ğ•©}
Repr â† '-'âŒ¾âŠ‘âŸ('Â¯'=âŠ‘) â€¢Repr

days â† â€¢HashMapËœâŸ¨âŸ©

_gen â† {ğ•© days.Set ğ•—}

_fxRand â† {p â† 10â‹†ğ•©-1 â‹„ p + ğ•¨ ğ•—.Range 9Ã—p} # ğ•©-digit numbers, no leading zeroes

_retryThis â† {ğ•¨ğ”½{ğ•¨ğ”½ğ•˜}ğ•© â€¢_while_(â‰¡âŸœretry) retry} # retry ğ•¨ğ”½ğ•© until result isn't retry

{ ğ•Šr:
  K â† r.Range
  Q â† {ğ•©â‰¥K 0}
  n â† ScaleF 4350
  fracZero â† 0.25
  fracHigh â† 0.2
  c â† 50
  {ğ•Š:
    r â† K 2
    o â† {0â‰ c? Q fracZero? 100|-âŸ(Â¬r) c; K 100}
    fo â† {Q fracHigh? 100Ã—1+K 9; 0} + o
    0â‰ fo?
    d â† oÃ—Â¯1â‹†r
    c2 â† 100|c+d
    (nâ‰ ğ•©+1) âˆ¨ 0â‰ c2? # don't end on 0 on last line
    c â†© c2
    (râŠ‘"LR")âˆ¾â€¢Repr fo
    ; retry
  }_retryThisÂ¨ â†•n
} _gen 1

ScaleD â† !
ScaleF â† !
retry â† {â‡}
{
  args â† â€¢args
  Arg â† {ğ•Š: (argsâ†“Ëœâ†©1) âŠ¢ (1âŒŠâ‰ )âŠ¸â†‘args}
  path â† â‹ˆâ¼ Arg@
  day â† â€¢ParseFloat (âˆ§`('0'âŠ¸â‰¤âˆ§â‰¤âŸœ'9'))âŠ¸/ â€¢file.Name path
  seed â† â‰ â—¶âŸ¨1, ("u"âŠ¸â‰¡â—¶âŸ¨â€¢ParseFloat, {ğ•Š: sâ†â€¢rand.Range 1e9 â‹„ â€¢Out "Seed: "âˆ¾â€¢Repr s â‹„ s}âŸ©)âŠ‘âŸ© Arg@
  ScaleD â†© ArgâŠ¸{âŸ¨âŸ©ğ•Šğ•©: ğ•©; âŸ¨aâŸ©ğ•Šğ•©: â€¢ParseFloat a}
  ScaleF â†© ArgâŠ¸{âŸ¨âŸ©ğ•Šğ•©: ğ•©; âŸ¨aâŸ©ğ•Šğ•©: mâ†'x'=Â¯1âŠ‘a â‹„ ğ•©âŠ¸Ã—âŸm â€¢ParseFloat m-âŠ¸â†“a}

  f â† days.Get day
  rng â† MakeRand seed
  rn â† 0
  args0 â† args
  res â† {ğ•Š: argsâ†©args0 â‹„ rn+â†©1 â‹„ F rng}â€¢_while_ (retryâŠ¸â‰¡) retry
  path â€¢FLines â‹ˆâŸ(2=â€¢Typeâˆ˜âŠ‘) <Ë˜âŸ(2==) res
  â€¢Out âˆ¾âŸ¨"Wrote ",path,{1â‰ rn? âˆ¾âŸ¨"; ",â€¢Repr rn, " retries"âŸ©; ""}âŸ©
}