#!/usr/bin/env bqn
# Usage: ./gen.bqn outputFilename [seed (u for random, 1 for default)] [...day-specific args]
# Day number is inferred as the numeric prefix of the filename
MakeRand â† â€¢MakeRand
âŸ¨MDSlash, Repr0â‡ReprâŸ© â† â€¢Import "../../utils/utils.bqn"

Join â† {(â‰ ğ•¨)â†“ âˆ¾ ğ•¨âŠ¸âˆ¾Â¨ ğ•©}
Repr â† '-'âŒ¾âŠ‘âŸ('Â¯'=âŠ‘) Repr0

days â† â€¢HashMapËœâŸ¨âŸ©

_gen â† {ğ•© days.Set ğ•—}

_fxRand â† {p â† 10â‹†ğ•©-1 â‹„ p + ğ•¨ ğ•—.Range 9Ã—p} # ğ•©-digit numbers, no leading zeroes

_retryThis â† {ğ•¨ğ”½{ğ•¨ğ”½ğ•˜}ğ•© â€¢_while_(â‰¡âŸœretry) retry} # retry ğ•¨ğ”½ğ•© until result isn't retry

{ ğ•Šr:
  K â† r.Range
  Q â† {ğ•©â‰¥K 0}
  n â† ScaleF 4350
  fracZero â† 0.25
  fracHigh â† 0.2
  c â† 50
  {ğ•Š:
    r â† K 2
    o â† {0â‰ c? Q fracZero? 100|-âŸ(Â¬r) c; K 100}
    fo â† {Q fracHigh? 100Ã—1+K 9; 0} + o
    0â‰ fo?
    d â† oÃ—Â¯1â‹†r
    c2 â† 100|c+d
    (nâ‰ ğ•©+1) âˆ¨ 0â‰ c2? # don't end on 0 on last line
    c â†© c2
    (râŠ‘"LR")âˆ¾â€¢Repr fo
    ; retry
  }_retryThisÂ¨ â†•n
} _gen 1


{ ğ•Šr:
  _rDist â† {âŒŠ ğ”½â¼ (r.Range 0)Ã—ğ”½ ğ•©}
  total â† ScaleF 2000000
  one â† ScaleF 200000
  max â† 1e10
  err â† 0.05Ã—total # tolerated deviation from total ID count
  
  NonRepeating â† {ğ•Š:
    s â† â€¢Repr ğ•©
    k â† â‰ s
    âˆ§Â´ {1â‰ â‰ â·âˆ˜â€¿ğ•©â¥Šs}Â¨ (0=|âŸœk)âŠ¸/ 1â†“â†•k
  }
  
  res â† ""
  curr â† 0
  startsâ€¿ends â† 2â¥Š<â†•0
  {ğ•Š:
    new â† 1
    k â† 2âŒˆâˆš _rDist one
    (curr+k)â‰¤total+err?
    start â† â‹†â¼ _rDist max
    end â† start+k
    âˆ§Â´Â¬ (startâ‰¤ends)âˆ§endâ‰¥starts? # range shouldn't overlap any previous range
    1â‰¥ -Â´ â‰ âˆ˜â€¢ReprÂ¨ endâ€¿start? # endpoint lengths should differ by at most 1 digit
    âˆ§Â´ 0.001<|0.5-1|0.5+ 10â‹†â¼ endâ€¿start? # endpoints shouldn't be an exact power of 10
    âˆ§Â´ NonRepeatingÂ¨ startâ€¿end? # endpoints themselves shouldn't be repeating
    curr+â†© k
    resâˆ¾â†© âˆ¾âŸ¨',', â€¢Repr start, '-', â€¢Repr endâŸ©
    startsâ€¿endsâˆ¾Â¨â†© startâ€¿end
    ;retry
  }_retryThis â€¢_while_{ğ•Š: currâ‰¤total-err} @
  1â†“res
} _gen 2

Gaussian â† {sğ•Šğ•©: (Ã·âˆš2Ã—Ï€Ã—Ã—Ëœs) Ã— â‹†-0.5Ã—Ã—Ëœğ•©Ã·s}
{ ğ•Šr:
  h â† ScaleF 200
  w â† ScaleF 100
  s â† ScaleD 5
  {ğ•Š:
    '1'+(w r.Range 0)â‹Ëœ +`(âŠ¢Ã·+Â´) 2â€¿7â€¿5â€¿3â€¿2â€¿1â€¿0.7â€¿0.4â€¿0.2 Ã— s Gaussian (Â¯8Ã—r.Range 0)+â†•9
  }Â¨ â†•h
} _gen 3

{ğ•Šr:
  side â† ScaleF 136
  sz â† sideâ€¿side
  b â† sz r.Range 2
  bâˆ¨â†© 2<(sz r.Range 0) Ã— +Â´ Â«â€¿Â»â€¿âŠ¢{ğ•ğ•©}Â¨< +Â´Â«â€¿Â»â€¿âŠ¢{ğ•ğ•©}Â¨< b
  âŠâŸœ".@" b
} _gen 4

{ğ•Šr:
  max â† 6e14
  rn â† ScaleF 184
  in â† ScaleF 1000
  rs â† âˆ˜â€¿2â¥Š âˆ§ (rnÃ—2) r.Range 0
  rs+â†© 0â‰Ë˜ rnÃ·âŠ¸Ã— {[a,b]: bÃ—Ã·0.4+a} 2â€¿rn r.Range 0
  
  rs â†© âŒŠmaxÃ—rs
  âˆ§Ë˜âŠ¸â‰¡ rs?
  rs r.Dealâˆ˜â‰ âŠ¸âŠâ†©
  rs â†© {âˆ¾âˆ¾âŸœ'-'âŒ¾âŠ‘ ReprÂ¨ ğ•©}Â¨ <Ë˜ rs
  is â† ReprÂ¨ âŒŠmaxÃ—in r.Range 0
  
  rs âˆ¾ âŸ¨""âŸ© âˆ¾ is
  ;retry
} _gen 5

{ğ•Šr:
  Ra â† r.Range
  n â† ScaleF 1000
  
  v â† 4
  h â† 4
  
  bs â† { ğ•Š:
    h â† 2+Ra h-1
    b â† '1'+vâ€¿h Ra 9
    i â† âŒŠvÃ— âˆ§ 4â‹†Ëœh Ra 0
    i 0âŒ¾âŠ‘â†©
    i âŒ½âŸ(Ra 2)â†©
    m â† (â†•v) <âŒœ i
    b â†© âŒ½âŸ(Ra 2) ' 'Â¨âŒ¾(mâŠ¸(/â—‹â¥Š)) b
    o â† {
      hâ‰¥4? '+';
      {1=Ra 4? '+'; '*'}
    }
    bâ‹ˆo
  }Â¨ â†•n
  
  res â† âˆ¾â‰ ' 'âŠ¸âˆ¾Ë˜Â¨âŒ¾(1âŠ¸â†“) âŠ‘Â¨bs
  resâˆ¾â†© Â¯1â†“âˆ¾ (1âŠ‘Â¨bs) â†‘ËœÂ¨ 1+â‰ âˆ˜âŠÂ¨ âŠ‘Â¨bs
} _gen 6

{ğ•Šr:
  Ra â† r.Range
  h â† ScaleF 70
  w â† 1+2Ã—h
  
  e â† wâ¥Š'.'
  
  m â† âˆ¾â‹ˆâŸœeÂ¨ {
    âŠâŸœ".^" (0â¥ŠËœh-ğ•©) (âˆ¾âˆ¾âŠ£) 1âŒ¾(Â¯1âŠ¸âŠ‘) 1âˆ¾ â¥Š0â‰Ë˜ 0â‰ ğ•© Ra 3
  }Â¨ â†•h
  
  âŸ¨'S'âŒ¾(hâŠ¸âŠ‘)e,eâŸ© âˆ¾ m
} _gen 7

# {ğ•Šr:
# } _gen

ScaleD â† !
ScaleF â† !
retry â† {â‡}
{
  args â† â€¢args
  Arg â† {ğ•Š: (argsâ†“Ëœâ†©1) âŠ¢ (1âŒŠâ‰ )âŠ¸â†‘args}
  path â† â‹ˆâ¼ Arg@
  day â† â€¢ParseFloat (âˆ§`('0'âŠ¸â‰¤âˆ§â‰¤âŸœ'9'))âŠ¸/ â€¢file.Name path
  seed â† â‰ â—¶âŸ¨1, ("u"âŠ¸â‰¡â—¶âŸ¨â€¢ParseFloat, {ğ•Š: sâ†â€¢rand.Range 1e9 â‹„ â€¢Out "Seed: "âˆ¾â€¢Repr s â‹„ s}âŸ©)âŠ‘âŸ© Arg@
  ScaleD â†© ArgâŠ¸{âŸ¨âŸ©ğ•Šğ•©: ğ•©; âŸ¨aâŸ©ğ•Šğ•©: â€¢ParseFloat a}
  ScaleF â†© ArgâŠ¸{âŸ¨âŸ©ğ•Šğ•©: ğ•©; âŸ¨aâŸ©ğ•Šğ•©: mâ†'x'=Â¯1âŠ‘a â‹„ ğ•©âŠ¸Ã—âŸm â€¢ParseFloat m-âŠ¸â†“a}

  f â† days.Get day
  rng â† MakeRand seed
  rn â† 0
  args0 â† args
  res â† {ğ•Š: argsâ†©args0 â‹„ rn+â†©1 â‹„ F rng}â€¢_while_ (retryâŠ¸â‰¡) retry
  path â€¢FLines â‹ˆâŸ(2=â€¢Typeâˆ˜âŠ‘) <Ë˜âŸ(2==) res
  â€¢Out âˆ¾âŸ¨"Wrote ",path,{1â‰ rn? âˆ¾âŸ¨"; ",â€¢Repr rn, " retries"âŸ©; ""}âŸ©
}