#!/usr/bin/env bqn
c â† â€¢FChars â‰ â—¶"15.in"â€¿âŠ‘ â€¢args

cc â† ',' = c
cs â† cc âˆ¨ (âˆŠâŸœ"=-" âˆ¨ '0'âŠ¸â‰¤ âˆ§ â‰¤âŸœ'9') c

ht â† {256|17Ã—ğ•©}âŸ(â†•âŒˆÂ´-âŸœÂ»/ccâˆ¾1) 1
ht â€¢internal.SqueezeÂ¨â†© # 670us â†’ 460us; TODO don't

ic â† â†•â‰ c
ci â† +`cc
ca â† c-@
HashTil â† { ğ•Šm:
  rm â† âŒ½m
  hm â† (âŒ½ ic - âŒˆ` (icÃ—rm) - Â¬rm)âŠht
  ca Ã— hm Ã— Â¬m
}

â€¢Show +Â´ {256 | (1Â«cc) Ã— ğ•© - âŒˆ`ğ•©Ã—cc} +` 256 | HashTil cc

vs â† (1Â«cc)/c        # values
vd â† '-'=vs          # is value deleted here
kn â† âŠ (cs-Ëœ csÂ¬âŠ¸Ã— +`csâˆ§Â¬Â»cs) âŠ” c # keys as unique numbers
lm â† âˆŠâŒ¾âŒ½kn           # last occurence mask
fv â† ('0'-Ëœlm/vs)âŒ¾((lm/kn)âŠ¸âŠ) Â¯2â¥ŠËœ1+âŒˆÂ´kn # map of key to final value
m1 â† Â¬knâˆŠ(lmâˆ§vd)/kn  # entries whose last operation is deletion
knâ€¿vd m1âŠ¸/Â¨â†©         # filter those out
pm â† âŠ’âŒ¾âŒ½ kn          # progressive counter
pl â† {âŠ‘1âŠËœâŒ½ğ•©}Â¨ knâŠ”vd # progressive counter of last deletion
wi â† â‰[kn,   pm]     # reference index
ti â† â‰[â†•â‰ pl, pl-1]   # target reference index - first entry after last deletion
tm â† wiâˆŠti           # mask of entries at the target

fhs â† 256| +Â´Â¨ ci âŠâŠ¸âŠ”â—‹((ciâˆŠtm//m1)âŠ¸/) HashTil cs # final filtered hashes
fvs â† (tm/kn) âŠ fv   # final filtered values
fvsÃ—â†© 1 + âŠ’fhs       # multiply values by their index in their bucket
â€¢Show +Â´ fvs Ã— 1+fhs # multiply by bucket number, sum