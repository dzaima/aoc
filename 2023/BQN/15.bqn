#!/usr/bin/env bqn
c â† â€¢FChars â‰ â—¶"15.in"â€¿âŠ‘ â€¢args

cc â† ',' = c       # commas
cs â† cc âˆ¨ (âˆŠâŸœ"=-" âˆ¨ '0'âŠ¸â‰¤ âˆ§ â‰¤âŸœ'9') c # non-key character
ce â† 1Â«cc          # end of an entry
el â† (âŠ¢-Â¯1Â»âŠ¢)/ccâˆ¾1 # entry lengths
ea â† -âŸœ1âŒ¾âŠ‘ el      # entry allocated length in input (comma goes to the entry following it)

ca â† c-@
ic â† â†•â‰ c
ht â† {256|17Ã—ğ•©}âŸ(â†•âŒˆÂ´el) 1
_hashTil â† { b ğ”½ _ğ•£ m:
  rm â† âŒ½m
  hm â† (âŒ½ ic - âŒˆ` (icÃ—rm) - Â¬rm)âŠht
  {ğ•© - âŒˆ`ğ•©Ã—b} +` ğ”½ 256 | ca Ã— hm Ã— Â¬m
}

â€¢Show +Â´ 256 | ce / cc âŠ¢_hashTil cc

vs â† ce / c          # values
vd â† '-' = vs        # is value deleted here
kn â† âŠ (((el+vd)>âŒœ3+â†•8) Ã— (/1âˆ¾cc)+âŒœ1+â†•8) âŠ '!'âˆ¾c
lo â† âˆŠâŒ¾âŒ½ kn          # last occurence mask
fv â† ('0'-Ëœlo/vs)âŒ¾((lo/kn)âŠ¸âŠ) Â¯2â¥ŠËœ1+âŒˆÂ´kn # map of key to final value
ld â† Â¬knâˆŠ(loâˆ§vd)/kn  # entries whose last operation is deletion
knâ€¿vd ldâŠ¸/Â¨ â†©        # filter those out
pm â† âŠ’âŒ¾âŒ½ kn          # progressive counter
wi â† â‰[kn,pm]        # reference index for each key
ti â† {               # target reference index - first entry after last deletion
  c â† /â¼ kn                 # fake progressive counter for each unique key for fake deletes
  s â† (1+â†•â‰ c) âˆ¾ vdÃ—1+kn     # a non-zero element n at index i means that, at time i (which can be of a fake delete), key n+1 is deleted
  â‰Â¯1 + s â‰â—‹((âˆŠâŒ¾âŒ½s)âŠ¸/) câˆ¾pm # filter progressive counters to last delete, sort by key
}
tm â† wiâˆŠti           # mask of entries at the target
cb â† â‰ âŸœÂ» /tm/ld/ea   # beginning of included in partially-filtered hash list
fhs â† 256 | (1Â«cb) / cb (ea/(â‰ ea)â†‘/â¼tm//ld)âŠ¸/ _hashTil cs # final filtered hashes
fvs â† (tm/kn) âŠ fv   # final filtered values
fvsÃ—â†© 1 + âŠ’fhs       # multiply values by their index in their bucket
â€¢Show +Â´ fvs Ã— 1+fhs # multiply by bucket number, sum