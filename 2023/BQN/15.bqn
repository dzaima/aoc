#!/usr/bin/env bqn
c â† â€¢FChars â‰ â—¶"15.in"â€¿âŠ‘ â€¢args

cc â† ',' = c # commas
cs â† cc âˆ¨ (âˆŠâŸœ"=-" âˆ¨ '0'âŠ¸â‰¤ âˆ§ â‰¤âŸœ'9') c # non-key character
ce â† 1Â«cc # end of an entry
el â† -âŸœÂ»/ccâˆ¾1 # entry lengths

ca â† c-@
ic â† â†•â‰ c
ht â† {256|17Ã—ğ•©}âŸ(â†•âŒˆÂ´el) 1
ht â€¢internal.SqueezeÂ¨â†© # 610us â†’ 400us; TODO don't
_hashTil â† { b ğ”½ _ğ•£ m:
  rm â† âŒ½m
  hm â† (âŒ½ ic - âŒˆ` (icÃ—rm) - Â¬rm)âŠht
  {ğ•© - âŒˆ`ğ•©Ã—b} +` ğ”½ 256 | ca Ã— hm Ã— Â¬m
}

â€¢Show +Â´ 256 | ce Ã— cc âŠ¢_hashTil cc

vs â† ce/c            # values
vd â† '-'=vs          # is value deleted here
kn â† âŠ (cs-Ëœ csÂ¬âŠ¸Ã— +`csâˆ§Â¬Â»cs) âŠ” c # keys as unique numbers
lo â† âˆŠâŒ¾âŒ½kn           # last occurence mask
fv â† ('0'-Ëœlo/vs)âŒ¾((lo/kn)âŠ¸âŠ) Â¯2â¥ŠËœ1+âŒˆÂ´kn # map of key to final value
ld â† Â¬knâˆŠ(loâˆ§vd)/kn  # entries whose last operation is deletion
knâ€¿vd ldâŠ¸/Â¨â†©         # filter those out
pm â† âŠ’âŒ¾âŒ½ kn          # progressive counter
pl â† {               # progressive counter of last deletion
  c â† /â¼ kn
  s â† (1+â†•â‰ c) âˆ¾ vdÃ—kn+1
  t â† 1 â†“ s â‹âŠ¸âŠâ—‹((âˆŠâŒ¾âŒ½s)âŠ¸/) câˆ¾pm
}
wi â† â‰[kn,   pm]     # reference index
ti â† â‰[â†•â‰ pl, pl-1]   # target reference index - first entry after last deletion
tm â† wiâˆŠti           # mask of entries at the target
cb â† â‰ âŸœÂ» /tm/ld/el   # beginning of included in partially-filtered hash list
fhs â† 256 | (1Â«cb) / cb (el/(â‰ el)â†‘/â¼tm//ld)âŠ¸/ _hashTil cs # final filtered hashes
fvs â† (tm/kn) âŠ fv   # final filtered values
fvsÃ—â†© 1 + âŠ’fhs       # multiply values by their index in their bucket
â€¢Show +Â´ fvs Ã— 1+fhs # multiply by bucket number, sum