#!/usr/bin/env cbqn
âŸ¨Ints, SplitâŸ© â† â€¢Import "utils.bqn"
l â† (IntsâŒ¾(1âŠ‘âŠ¢) ' 'SplitâŠ¢)Â¨ â€¢FLines â‰ â—¶"12.in"â€¿âŠ‘ â€¢args

Fn â† { ğ•Š lâ€¿i:
  max â† âŒˆÂ´i
  in â† â‰ i
  iâˆ¾â†© Â¯1
  nâ€¿Â·â€¿o â† âŸ¨1âŸ©â€¿âŸ¨0âŸ©â€¿âŸ¨0âŸ© { nâ€¿sâ€¿o ğ•Š c: # count,streak,offset ğ•Š char
    r1 â† {âŠ‘câˆŠ"?#"? mâ†s<oâŠi â‹„ âŸ¨m/n, 1+m/s, m/oâŸ©; 3â¥Š<â†•0} # results from '?'/'#'; filters out too-high streaks
    r2 â† {âŠ‘câˆŠ"?."? jâ†s=oâŠi â‹„ mâ†jâˆ¨s=0 â‹„ âŸ¨m/n, 0â¥ŠËœ+Â´m, m/o+jâŸ©; 3â¥Š<â†•0} # results from '?'/'.'
    nâ€¿sâ€¿o â†© r1âˆ¾Â¨r2 # all results
    u â† â‰sâ‰o
    m â† âˆŠu # deduplicate by streak,offset
    âŸ¨+Â´Â¨ (âŠu)âŠ”n, m/s, m/oâŸ© # and sum the counts by the group
  }ËœÂ´âŒ½ lâˆ¾'.'
  +Â´ (in=o) / n
}

â€¢Show +Â´ FnÂ¨ l
â€¢Show +Â´ Fnâˆ˜{lâ€¿i: âŸ¨Â¯1â†“âˆ¾5â¥Š<lâˆ¾'?', âˆ¾5â¥Š<iâŸ©}Â¨ l