#!/usr/bin/env cbqn
âŸ¨RB,IntsâŸ© â† â€¢Import "../../utils/utils.bqn"
l â† â€¢FLines â‰ â—¶"14.in"â€¿âŠ‘ â€¢args

i â† {
  'a'=1âŠ‘ğ•©? # mask
    0â‹ˆ ('X'âŠ¸= â‹ˆ '1'âŠ¸=) 7â†“ğ•©
  ; # else, mem
    1â‹ˆ Ints ğ•©
}Â¨l

itâ€¿ia â† <Ë˜â‰>i # instruction type & arguments

UB â† (2| Â·âŒŠ (âŒ½Ã·2â‹†â†•36)âŠ¸Ã—) # unpack binary

wm â† {ğ•©âŠËœÂ¯1+ğ•©â‹â†•â‰ it} /Â¬it # map from write instr to the nearest preceding mask
wim â† (it/wm)âŠia # write instruction masks
wimX â† 0âŠ‘Â¨wim # write ins mask keep/float
wimS â† 1âŠ‘Â¨wim # write ins mask set

wil â† it/ia # write ins arguments
wia â† 0âŠ‘Â¨wil # write ins addresses
wiv â† 1âŠ‘Â¨wil # write ins values

{
  wl â† âˆŠâŒ¾âŒ½ wia # mask of which Write instructions are the Last for this address
  â€¢Show +Â´RBÂ¨ (wl/wimS)âˆ¨(wl/wimX)âˆ§UBÂ¨ wl/wiv
}

{
  e â† 2â‹†+Â´Â¨wimX # number of sub-writes
  ewa â† âˆ¾((wimS âˆ¨ UBÂ¨ wia)âˆ§Â¬wimX) {ğ•¨<âŠ¸âˆ¨ â¥Šâ†•1+ğ•©}Â¨ wimX # expanded write addresses
  ewv â† e/wiv # expanded write values
  wl â† âˆŠâŒ¾âŒ½ ewa # mask of which Write instructions are the Last for this address
  â€¢Show +Â´wl/ewv
}