#!/usr/bin/env bqn
âŸ¨Ints, Count, Split, SplitFâŸ© â† â€¢Import "../../utils/utils.bqn"
l â† âŸ¨âŸ© SplitF â€¢FLines â‰ â—¶"20.in"â€¿âŠ‘ â€¢args

n â† â‹ˆâ¼âˆ˜Intsâˆ˜âŠ‘Â¨ l
v â† '#'=>Â¨ 1â†“Â¨l

edges â† {>âŠÂ¨ âŒ½âˆ˜â‰âŸ(â†•4) ğ•©}Â¨ v # order: top, right, bottom, left; TODO do less stupidly
all â† âˆ¾ âˆ¾âŸœ(âŒ½Ë˜)Â¨ edges # order: t,r,b,l, reversed t,r,b,l
allIdx â† 8/â†•â‰ l # group index for each edge

RotCW â† {(8Ã—ğ•©âŠ‘allIdx) + (8|ğ•©) âŠ‘ 1â€¿2â€¿3â€¿0â€¿7â€¿4â€¿5â€¿6}
RotCCW â† {(8Ã—ğ•©âŠ‘allIdx) + (8|ğ•©) âŠ‘ 3â€¿0â€¿1â€¿2â€¿5â€¿6â€¿7â€¿4}
# Opposite â† {(8Ã—ğ•©âŠ‘allIdx) + (8|ğ•©) âŠ‘ 2â€¿3â€¿0â€¿1â€¿6â€¿7â€¿4â€¿5}
Opposite â† {(8Ã—ğ•©âŠ‘allIdx) + (8|ğ•©) âŠ‘ 6â€¿7â€¿4â€¿5â€¿2â€¿3â€¿0â€¿1}

corners â† / 2=+Â´Â¨2= (Â¯1+`(4â†‘1)â¥ŠËœâ‰ )âŠ¸âŠ” all Countâ—‹(<Ë˜)Ëœ âˆ¾edges # TODO remove <Ë˜ after Count makes sense of it

# â€¢Show ('0'+<Ë˜all)â‰Ë˜allMap
next â† âŠ‘Â¨ âˆ¾âŸœÂ¯1Â¨ {iâ†âŠall â‹„ ğ•©âŠ¸â‰ âŠ¸(/Â¨) iâŠiâŠ”ğ•©}â†•â‰ all # for each edge, the adjacent ones' index

# â€¢Show nextâ‰Ë˜Ëœâ†•â‰ next

â€¢Show Ã—Â´ cornersâŠn # no need to actually reconstruct the image yet

GetNext â† { ğ•Ši: # takes edge number, gets adjacent tile & gives its next edge
  nt â† iâŠ‘next # next tile matching edge
  ntâ‰¢Â¯1? Opposite nt; Â¯1
}

# horrible mess follows:

start â† âŠ‘corners # top left corner tile number
startEdge â† {!2=â‰ ğ•©â‹„âŠ‘ğ•©} {âˆ§Â´Â¯1â‰ nextâŠËœRotCWâŠ¸â‹ˆ ğ•©}Â¨âŠ¸/ (8Ã—start)+â†•8 # edge of that which also continues after RotCW
NextList â† {Â¯1â†“ (âŠ¢âˆ¾âŸœ< Â·GetNext Â¯1âŠ‘âŠ¢)â€¢_while_(Â¯1â‰¢Â¯1âŠ‘âŠ¢) â‹ˆğ•©}
leftCol â† NextList startEdge

gridNs â† >{NextList RotCW ğ•©}Â¨ leftCol

grid0 â† âŒ½(8|gridNs) {ğ•¨â—¶âŸ¨â‰âŒ½,âŠ¢,âŒ½â‰,âŒ½âŒ½Ë˜,âŒ½âˆ˜â‰âˆ˜âŒ½,âŒ½,â‰,âŒ½Ë˜âŸ© ğ•©}Â¨ (gridNsâŠallIdx)âŠv
! {ğ•©â‰¡2/Ë˜2/(2|â†•Â¨â‰¢ğ•©)/ğ•©} Â¯2â€¿Â¯2â†“1â€¿1âŒ½âˆ¾{0â€¿Â¯1âŠ¸âŠË˜0â€¿Â¯1âŠğ•©}Â¨ grid0 # verify that we've gotten the proper grid
grid â† âˆ¾{Â¯1â€¿Â¯1â†“1â€¿1â†“ğ•©}Â¨ grid0 # and now with removed borders

seaMonster â† '#'=(@+10)Split 1â†“"
                  # 
#    ##    ##    ###
 #  #  #  #  #  #   "
seaMonsterW â† â‰ âŠ‘seaMonster
seaMonsterIdxs â† /Â¨ seaMonster

# â€¢Show gridâŠ".#"
# â€¢Show ".#"âŠËœ >seaMonster

Find â† {
  offs â† Â»âŸ(â†•seaMonsterW) ğ•©
  t â† {âˆ§Â´ğ•©âŠoffs}Â¨ seaMonsterIdxs # for each sea monster row, where it matches in the grid
  a â† âˆ§Â´{(ğ•©â¥Š0)âŠ¸Â»Ë˜ğ•¨}Â¨âŸœ(â†•â‰ ) t
  b â† âˆ§Â´{(ğ•©â¥Š0)âŠ¸Â«Ë˜ğ•¨}Â¨âŸœ(â†•â‰ ) t
  a âˆ¨ b
}

a â† Find grid
b â† â‰Find â‰grid

â€¢Show (+Â´â¥Šgrid) - (+Â´â‰ Â¨ seaMonsterIdxs) Ã— +Â´+Â´âˆ˜â¥ŠÂ¨ aâ€¿b # assumes sea monsters don't overlap